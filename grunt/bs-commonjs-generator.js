'use strict';
var fs = require('fs');
var path = require('path');

var COMMONJS_BANNER = '// This file is autogenerated via the `commonjs` Grunt task. You can require() this file in a CommonJS environment.\n';
var JQUERY_REQUIRE = 'var jQuery = require(\'jquery\');\n\n';
var EXPORTS_HEAD = 'module.exports = function () {\n';
var EXPORTS_END = '\n};';

module.exports = function generateCommonJSModule(grunt, srcFiles, destFilepath) {
  var destDir = path.dirname(destFilepath);

  function srcPathToDestRequire(srcFilepath) {
    var requirePath = path.relative(destDir, srcFilepath).replace(/\\/g, '/');
    return '\trequire(\'' + requirePath + '\')';
  }

  var moduleOutputJs = COMMONJS_BANNER + JQUERY_REQUIRE + EXPORTS_HEAD +
      srcFiles.map(srcPathToDestRequire).join('\n') + EXPORTS_END;
  try {
    fs.writeFileSync(destFilepath, moduleOutputJs);
  }
  catch (err) {
    grunt.fail.warn(err);
  }
  grunt.log.writeln('File ' + destFilepath.cyan + ' created.');
};
